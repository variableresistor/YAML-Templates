# Publishes a PowerShell module to the PowerShell Gallery
parameters:
  - name: ModuleName
    type: string
    displayName: Name of the module to publish

steps:
  - task: UseDotNet@2
    displayName: Use Dotnet 7.x
    inputs:
      version: 7.x

  - pwsh: |
      (Get-Content "./$env:ModuleName.psd1") -replace "ModuleVersion = '.*'","ModuleVersion = '$env:Version'" |
      Set-Content -Path "./$env:ModuleName.psd1" -PassThru
      if (Get-Module -Name $env:ModuleName -ListAvailable)
      {
        Remove-Module -Name $env:ModuleName -ErrorAction SilentlyContinue
        Uninstall-Module -Name $env:ModuleName -AllVersion -Verbose
      }
      $env:PSModulePath += ";$env:Pipeline_Workspace"
      if (Test-Path ".\.github") { Remove-Item ".\.github" -Recurse -Verbose }
      gci -File -Filter "*.Tests.*ps*" -Recurse | Remove-Item -Verbose
      Import-Module $env:ModuleName -Verbose -RequiredVersion $env:Version

      Publish-Module -Name $env:ModuleName -Repository PSGallery -NuGetApiKey $env:NuGetApiKey -Verbose -WhatIf
    displayName: 'Publish the module'
    workingDirectory: $(Pipeline.Workspace)/${{parameters.ModuleName}}
    env:
      Version: $(Build.BuildNumber)
      ModuleName: ${{parameters.ModuleName}}
      NuGetApiKey: $(NuGetApiKey)